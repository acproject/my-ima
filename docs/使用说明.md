# MY-IMA 使用说明

## 1. 项目简介

MY-IMA 是一个轻量级、可嵌入、可扩展的 IAM / Auth Server。当前实现包含：

- Realm（租户）管理
- 用户注册/登录（JWT）
- 角色管理（Role）
- 权限模型（Permission：`resource:action`）
- 用户-角色、角色-权限关联

服务默认端口为 `8086`（见 [application.yml](file:///Users/acproject/workspace/java_projects/my-ima/src/main/resources/application.yml#L1-L4)）。

## 2. 运行环境

- JDK 21（见 [pom.xml](file:///Users/acproject/workspace/java_projects/my-ima/pom.xml#L29-L37)）
- Maven 3.x
- 可选：Docker（用于快速启动 PostgreSQL）

## 3. 配置与 Profile

项目使用两个主要 profile：

- `dev`：默认 profile，不启用数据库/JOOQ/Liquibase（适合本地快速调试，使用内存仓库实现）
- `prod`：启用 PostgreSQL + JOOQ + Liquibase（适合集成/联调）

对应配置见 [application.yml](file:///Users/acproject/workspace/java_projects/my-ima/src/main/resources/application.yml#L4-L40)。

## 4. 快速开始

### 4.1 dev 模式启动（无数据库）

dev 模式默认启用，直接启动：

```bash
mvn spring-boot:run
```

验证：

```bash
curl http://localhost:8086/api/health
```

### 4.2 prod 模式启动（PostgreSQL + Liquibase + JOOQ）

#### 方式 A：用 docker-compose 启动 PostgreSQL

项目提供了 `docker-compose.postgres.yml`（默认映射本机 5432 端口）：

```bash
docker compose -f docker-compose.postgres.yml up -d
```

#### 方式 B：本地已有 PostgreSQL

确保 PostgreSQL 已运行，并创建数据库（脚本可选）：

```bash
bash scripts/setup-database.sh
```

#### 启动应用（prod profile）

```bash
mvn spring-boot:run -Dspring-boot.run.profiles=prod
```

启动后 Liquibase 会自动执行迁移（见 [master.xml](file:///Users/acproject/workspace/java_projects/my-ima/src/main/resources/db/migration/master.xml) 和 [V1__Initial_Schema.sql](file:///Users/acproject/workspace/java_projects/my-ima/src/main/resources/db/migration/V1__Initial_Schema.sql)）。

## 5. 鉴权与调用方式

安全策略见 [SecurityConfig.java](file:///Users/acproject/workspace/java_projects/my-ima/src/main/java/com/owiseman/core/security/SecurityConfig.java#L29-L47)：

- 放行：`/api/auth/**`、`/api/health`、`/actuator/**`
- 其他 `/api/**` 需要 `Authorization: Bearer <token>`

### 5.1 注册

```bash
curl -X POST http://localhost:8086/api/auth/register \
  -H "Content-Type: application/json" \
  -d '{
    "username": "alice",
    "email": "alice@example.com",
    "password": "password123",
    "realmId": "00000000-0000-0000-0000-000000000000"
  }'
```

接口定义见 [AuthController.java](file:///Users/acproject/workspace/java_projects/my-ima/src/main/java/com/owiseman/core/web/controller/AuthController.java#L41-L53)。

返回体里包含 `accessToken` 和 `userId`（DTO： [AuthResponse.java](file:///Users/acproject/workspace/java_projects/my-ima/src/main/java/com/owiseman/core/web/dto/AuthResponse.java)）。

### 5.2 登录

```bash
curl -X POST http://localhost:8086/api/auth/login \
  -H "Content-Type: application/json" \
  -d '{
    "username": "alice",
    "password": "password123",
    "realmId": "00000000-0000-0000-0000-000000000000"
  }'
```

### 5.3 携带 Token 调用受保护接口

```bash
curl http://localhost:8086/api/realms \
  -H "Authorization: Bearer <accessToken>"
```

## 6. Realm API

实现见 [RealmController.java](file:///Users/acproject/workspace/java_projects/my-ima/src/main/java/com/owiseman/core/web/controller/RealmController.java)。

常用接口：

- `POST /api/realms` 创建 realm
- `GET /api/realms` 列表
- `GET /api/realms/{id}` 查询
- `POST /api/realms/{id}/enable` 启用
- `POST /api/realms/{id}/disable` 禁用
- `GET /api/realms/count` 总数

创建示例：

```bash
curl -X POST http://localhost:8086/api/realms \
  -H "Authorization: Bearer <accessToken>" \
  -H "Content-Type: application/json" \
  -d '{"name":"demo-realm","enabled":true}'
```

## 7. Role API

实现见 [RoleController.java](file:///Users/acproject/workspace/java_projects/my-ima/src/main/java/com/owiseman/core/web/controller/RoleController.java)。

常用接口：

- `POST /api/roles` 创建角色（需要 `realmId`）
- `GET /api/roles/{id}` 查询
- `GET /api/roles/realm/{realmId}` 按 realm 列表
- `POST /api/roles/{roleId}/permissions/{permissionId}` 为角色分配权限
- `GET /api/roles/{id}/permissions` 查看角色权限（返回字符串列表）
- `GET /api/roles/realm/{realmId}/count` 统计某个 realm 的角色数

创建示例：

```bash
curl -X POST http://localhost:8086/api/roles \
  -H "Authorization: Bearer <accessToken>" \
  -H "Content-Type: application/json" \
  -d '{
    "realmId":"<realmId>",
    "name":"admin",
    "description":"管理员"
  }'
```

## 8. User API

实现见 [UserController.java](file:///Users/acproject/workspace/java_projects/my-ima/src/main/java/com/owiseman/core/web/controller/UserController.java)。

常用接口：

- `GET /api/users/{id}` 查询用户
- `GET /api/users/realm/{realmId}` 列表（分页参数：`page`、`size`）
- `POST /api/users/{userId}/roles/{roleId}` 给用户分配角色
- `GET /api/users/{userId}/roles` 查看用户角色（字符串列表）
- `GET /api/users/{userId}/permissions` 查看用户权限（字符串列表）
- `GET /api/users/{userId}/permissions/{permission}` 判断是否有某权限（返回 `true/false`）
- `GET /api/users/realm/{realmId}/count` 统计某个 realm 的用户数

## 9. Permission 的创建与 countByRealm

### 9.1 当前状态：没有 PermissionController

目前代码中没有 `/api/permissions` 相关控制器，因此如果你需要在纯 API 流程里“创建权限”，需要通过：

- 直接写入数据库（prod 模式）
- 或在服务内部通过仓库接口创建（dev/prod 都可）

### 9.2 数据库方式创建 Permission（prod 模式）

表结构见 [V1__Initial_Schema.sql](file:///Users/acproject/workspace/java_projects/my-ima/src/main/resources/db/migration/V1__Initial_Schema.sql#L70-L87)，`ima_permission` 至少需要：

- `realm_id`
- `name`（通常用 `resource:action`）
- `resource`
- `action`

示例（把 `<realmId>` 替换为实际 UUID）：

```sql
insert into ima_permission (realm_id, name, resource, action)
values ('<realmId>', 'users:read', 'users', 'read')
returning id;
```

拿到 `permissionId` 后即可调用：

```bash
curl -X POST http://localhost:8086/api/roles/<roleId>/permissions/<permissionId> \
  -H "Authorization: Bearer <accessToken>"
```

### 9.3 代码方式创建 Permission

接口定义见 [PermissionRepository.java](file:///Users/acproject/workspace/java_projects/my-ima/src/main/java/com/owiseman/core/jooq/repository/PermissionRepository.java#L9-L26)，prod 实现见 [JooqPermissionRepository.java](file:///Users/acproject/workspace/java_projects/my-ima/src/main/java/com/owiseman/core/jooq/repository/impl/JooqPermissionRepository.java#L63-L88)。

`countByRealm(UUID realmId)` 的实现见 [countByRealm](file:///Users/acproject/workspace/java_projects/my-ima/src/main/java/com/owiseman/core/jooq/repository/impl/JooqPermissionRepository.java#L135-L142)。

## 10. JOOQ 代码生成

生成配置在 [pom.xml](file:///Users/acproject/workspace/java_projects/my-ima/pom.xml#L135-L201)，生成目录为：

- `target/generated-sources/jooq`

常用命令：

```bash
mvn -q generate-sources
```

## 11. 测试

运行全部测试：

```bash
mvn test
```

端到端测试在：

- [ProjectCapabilitiesE2ETest.java](file:///Users/acproject/workspace/java_projects/my-ima/src/test/java/com/owiseman/core/e2e/ProjectCapabilitiesE2ETest.java)

## 12. 常见问题

### 12.1 401 Unauthorized

- 受保护接口必须带 `Authorization: Bearer <accessToken>`
- 先调用 `/api/auth/register` 或 `/api/auth/login` 获取 token

### 12.2 prod 启动连不上数据库

- 确认 PostgreSQL 端口、用户名、密码、数据库名与 `application.yml` 的 `prod` 配置一致
- 如果使用 docker-compose，确认容器健康检查通过并已映射 `5432:5432`

